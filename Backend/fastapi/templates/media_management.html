{% extends "base.html" %}

{% block title %}Manage {{ media_type|title }}s - Links4U Admin{% endblock %}

{% block content %}
<div class="p-6 md:p-12">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-white">Library Manager</h1>
            <p class="text-white/40 text-sm mt-1">Editing {{ media_type|title }} Database</p>
        </div>
        <div class="flex bg-surface-light rounded-lg p-1 border border-white/5">
            <a href="?media_type=movie" class="px-6 py-2 rounded-md text-sm font-medium transition-all {% if media_type == 'movie' %}bg-white text-black shadow-lg{% else %}text-white/50 hover:text-white{% endif %}">Movies</a>
            <a href="?media_type=tv" class="px-6 py-2 rounded-md text-sm font-medium transition-all {% if media_type == 'tv' %}bg-white text-black shadow-lg{% else %}text-white/50 hover:text-white{% endif %}">TV Shows</a>
        </div>
    </div>

    <div class="max-w-2xl mb-8 relative">
        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-white/30"></i>
        <input type="text" id="search-input" placeholder="Search database by title..." 
               class="w-full bg-surface-light border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white placeholder-white/20 focus:outline-none focus:border-white/40 transition-colors">
    </div>

    <div id="media-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
        </div>

    <div id="pagination" class="flex justify-center gap-2 mt-12 text-sm"></div>

    <div id="loading" class="hidden text-center py-20 text-white/30">
        <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
    </div>
</div>

<script>
    let currentPage = 1;
    let currentSearch = '';
    const mediaType = '{{ media_type }}';

    async function loadMedia(page = 1, search = '') {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('media-grid').innerHTML = '';
        
        try {
            const res = await fetch(`/api/media/list?media_type=${mediaType}&page=${page}&search=${search}`);
            const data = await res.json();
            
            const items = mediaType === 'movie' ? data.movies : data.tv_shows;
            
            document.getElementById('media-grid').innerHTML = items.map(item => `
                <div class="group relative bg-surface-light rounded-xl overflow-hidden border border-white/5 hover:border-white/20 transition-all">
                    <div class="aspect-[2/3] relative">
                        <img src="${item.poster || ''}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                            <a href="/admin/media/edit?tmdb_id=${item.tmdb_id}&db_index=${item.db_index}&media_type=${mediaType}" 
                               class="bg-white text-black px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-200">EDIT</a>
                            <button onclick="deleteMedia(${item.tmdb_id}, ${item.db_index}, '${item.title.replace(/'/g, "\\'")}')" 
                                    class="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-500/30">DELETE</button>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-bold text-white truncate">${item.title}</h3>
                        <p class="text-xs text-white/40 mt-1">${item.release_year}</p>
                    </div>
                </div>
            `).join('');

            renderPagination(data.current_page, data.total_pages);
        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function renderPagination(current, total) {
        const pag = document.getElementById('pagination');
        if (total <= 1) { pag.innerHTML = ''; return; }
        
        let html = '';
        if (current > 1) html += `<button onclick="loadMedia(${current-1}, '${currentSearch}')" class="px-3 py-1 bg-surface-light rounded hover:bg-white/10">Prev</button>`;
        html += `<span class="px-3 py-1 text-white/50">Page ${current} of ${total}</span>`;
        if (current < total) html += `<button onclick="loadMedia(${current+1}, '${currentSearch}')" class="px-3 py-1 bg-surface-light rounded hover:bg-white/10">Next</button>`;
        pag.innerHTML = html;
    }

    async function deleteMedia(id, index, title) {
        if(!confirm(`Delete "${title}"? This cannot be undone.`)) return;
        await fetch(`/api/media/delete?tmdb_id=${id}&db_index=${index}&media_type=${mediaType}`, { method: 'DELETE' });
        loadMedia(currentPage, currentSearch);
    }

    // Debounce Search
    let timeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            currentSearch = e.target.value;
            currentPage = 1;
            loadMedia(1, currentSearch);
        }, 500);
    });

    loadMedia();
</script>
{% endblock %}
