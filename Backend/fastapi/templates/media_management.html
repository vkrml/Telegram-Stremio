{% extends "base.html" %}

{% block title %}Library Manager{% endblock %}

{% block content %}
<div class="p-6 md:p-12 w-full max-w-[1600px] mx-auto">
    
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white">Manage <span class="text-primary">{{ media_type|upper }}</span></h1>
        <div class="flex bg-surface rounded-lg p-1 border border-white/10">
            <a href="?media_type=movie" class="px-5 py-2 rounded text-xs font-bold transition-all {% if media_type == 'movie' %}bg-white text-black{% else %}text-text-muted hover:text-white{% endif %}">MOVIES</a>
            <a href="?media_type=tv" class="px-5 py-2 rounded text-xs font-bold transition-all {% if media_type == 'tv' %}bg-white text-black{% else %}text-text-muted hover:text-white{% endif %}">TV SHOWS</a>
        </div>
    </div>

    <input type="text" id="search-input" placeholder="Filter by title..." 
           class="w-full max-w-md bg-surface border border-white/10 rounded-lg px-4 py-3 text-white focus:border-primary/50 focus:outline-none mb-10 transition-colors">

    <div id="media-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
    <div id="pagination" class="flex justify-center gap-2 mt-12 text-sm font-bold text-text-muted"></div>
</div>

<script>
    let currentPage = 1;
    let currentSearch = '';
    const mediaType = '{{ media_type }}';

    async function loadMedia(page = 1, search = '') {
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '<div class="col-span-full text-center py-20 text-text-muted">Loading data...</div>';
        
        try {
            const res = await fetch(`/api/media/list?media_type=${mediaType}&page=${page}&search=${search}`);
            const data = await res.json();
            const items = mediaType === 'movie' ? data.movies : data.tv_shows;
            
            grid.innerHTML = items.map(item => `
                <div class="bg-surface rounded-lg overflow-hidden border border-white/5 group">
                    <div class="aspect-[2/3] relative">
                        <img src="${item.poster || ''}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4">
                            <a href="/admin/media/edit?tmdb_id=${item.tmdb_id}&db_index=${item.db_index}&media_type=${mediaType}" 
                               class="bg-white text-black px-4 py-2 rounded text-xs font-bold w-full text-center hover:bg-gray-200">EDIT</a>
                            <button onclick="deleteMedia(${item.tmdb_id}, ${item.db_index}, '${item.title.replace(/'/g, "\\'")}')" 
                                    class="bg-red-500/20 text-red-500 border border-red-500/50 px-4 py-2 rounded text-xs font-bold w-full hover:bg-red-500 hover:text-white transition-colors">DELETE</button>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-bold text-white truncate">${item.title}</h3>
                        <p class="text-xs text-text-muted mt-1 font-mono">${item.release_year}</p>
                    </div>
                </div>
            `).join('');

            const pag = document.getElementById('pagination');
            if (data.total_pages > 1) {
                let html = '';
                if (page > 1) html += `<button onclick="loadMedia(${page-1}, '${currentSearch}')" class="px-3 py-1 bg-surface rounded hover:bg-white/10 mr-2">Prev</button>`;
                html += `<span class="px-3 py-1 text-white border border-white/10 rounded bg-white/5">${page} / ${data.total_pages}</span>`;
                if (page < data.total_pages) html += `<button onclick="loadMedia(${page+1}, '${currentSearch}')" class="px-3 py-1 bg-surface rounded hover:bg-white/10 ml-2">Next</button>`;
                pag.innerHTML = html;
            } else {
                pag.innerHTML = '';
            }

        } catch (e) {
            console.error(e);
        }
    }

    async function deleteMedia(id, index, title) {
        if(!confirm(`Delete "${title}" permanently?`)) return;
        await fetch(`/api/media/delete?tmdb_id=${id}&db_index=${index}&media_type=${mediaType}`, { method: 'DELETE' });
        loadMedia(currentPage, currentSearch);
    }

    let timeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            currentSearch = e.target.value;
            currentPage = 1;
            loadMedia(1, currentSearch);
        }, 500);
    });

    loadMedia();
</script>
{% endblock %}
