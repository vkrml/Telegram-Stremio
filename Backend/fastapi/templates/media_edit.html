{% extends "base.html" %}

{% block title %}Edit Metadata{% endblock %}

{% block content %}
<div class="w-full max-w-5xl mx-auto px-4 md:px-8 py-8">
    
    <div class="mb-8 flex items-center justify-between">
        <div>
            <a href="/admin/media/manage?media_type={{ media_type }}" class="text-xs font-bold uppercase tracking-widest hover:underline mb-1 block"><i class="fa-solid fa-arrow-left mr-1"></i> Back</a>
            <h1 class="font-serif text-3xl font-bold">Edit Metadata</h1>
        </div>
        <span class="font-mono text-xs bg-black text-white px-2 py-1 font-bold">ID: {{ tmdb_id }}</span>
    </div>

    <form onsubmit="updateMedia(event)" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        <div class="md:col-span-1 space-y-4">
            <div class="border-2 border-black p-1 bg-white shadow-brutal-sm">
                <img src="{{ media_details.poster }}" class="w-full">
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase mb-1">Poster URL</label>
                <input type="text" name="poster" value="{{ media_details.poster }}" class="w-full border-2 border-black px-2 py-1 text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase mb-1">Backdrop URL</label>
                <input type="text" name="backdrop" value="{{ media_details.backdrop }}" class="w-full border-2 border-black px-2 py-1 text-xs">
            </div>
        </div>

        <div class="md:col-span-2 space-y-6 bg-white p-6 border-2 border-black shadow-brutal">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase mb-1">Title</label>
                    <input type="text" name="title" value="{{ media_details.title }}" class="w-full border-2 border-black px-3 py-2 font-bold text-lg">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1">Year</label>
                    <input type="number" name="release_year" value="{{ media_details.release_year }}" class="w-full border-2 border-black px-3 py-2 font-bold">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1">Rating</label>
                    <input type="number" step="0.1" name="rating" value="{{ media_details.rating }}" class="w-full border-2 border-black px-3 py-2 font-bold">
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase mb-1">Overview</label>
                <textarea name="description" rows="6" class="w-full border-2 border-black px-3 py-2 text-sm">{{ media_details.description }}</textarea>
            </div>
            <button type="submit" class="bg-black text-white font-bold px-6 py-3 w-full uppercase text-xs tracking-widest hover:bg-accent hover:text-black border-2 border-transparent hover:border-black transition-all">Save Changes</button>
        </div>
    </form>

    <div class="border-t-2 border-black pt-8">
        <h2 class="font-serif text-xl font-bold mb-4">Linked Files</h2>
        
        {% if media_type == 'movie' %}
            <div class="space-y-2">
                {% for file in media.telegram %}
                <div class="flex justify-between items-center bg-white p-3 border border-black">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="bg-black text-white text-[10px] font-bold px-1">{{ file.quality }}</span>
                        <span class="text-xs truncate max-w-xs">{{ file.name }}</span>
                    </div>
                    <button type="button" onclick="deleteFile('{{ file.id }}')" class="text-[10px] font-bold text-red-600 hover:underline uppercase">Remove</button>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-xs text-gray-500">Episode file management is available via direct API or re-indexing.</p>
        {% endif %}
    </div>
</div>

<script>
    async function updateMedia(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        await fetch(`/api/media/update?tmdb_id={{ tmdb_id }}&db_index={{ db_index }}&media_type={{ media_type }}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
        alert('Saved'); location.reload();
    }
    async function deleteFile(id) {
        if(confirm('Remove file?')) { await fetch(`/api/media/delete-quality?tmdb_id={{ tmdb_id }}&db_index={{ db_index }}&id=${id}`, { method: 'DELETE' }); location.reload(); }
    }
</script>
{% endblock %}
